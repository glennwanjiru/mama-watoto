<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mama Watoto Home Care - Poster Maker</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&family=Nunito:wght@400;700&family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600;700&family=Montserrat:wght@400;700;900&family=Dancing+Script:wght@700&family=Lora:ital,wght@0,400;0,600;1,400&family=Oswald:wght@500;700&family=Raleway:wght@300;800&family=Roboto+Slab:wght@400;700&family=Amatic+SC:wght@700&family=Quicksand:wght@500;700&family=Cinzel:wght@600&family=Anton&family=Bebas+Neue&family=Abril+Fatface&family=Chewy&family=Comic+Neue:wght@700&family=Patrick+Hand&family=Bangers&display=swap" rel="stylesheet">
    
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <!-- html2canvas for downloading images -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <!-- jsPDF for downloading PDFs -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        /* Custom Scrollbar */
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Aspect Ratio Classes - High Res Base Dimensions */
        .poster-wrapper {
            position: absolute;
            top: 50%;
            left: 50%;
            transform-origin: center center;
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
            background-color: white;
            transition: width 0.3s ease, height 0.3s ease, transform 0.1s ease;
        }

        .poster-container {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            /* Dynamic Theme Variables */
            --primary: #0f766e; /* Default Teal */
            --secondary: #f97316; /* Default Orange */
            --bg: #ffffff;
            --text-main: #1f2937;
            --text-light: #6b7280;
            --font-head: 'Playfair Display', serif;
            --font-body: 'Poppins', sans-serif;
        }
        
        /* Apply dynamic fonts */
        .poster-container h1, .poster-container h2, .poster-container h3, .brand-text {
            font-family: var(--font-head) !important;
        }
        .poster-container p, .poster-container li, .poster-container span, .poster-container div {
            font-family: var(--font-body) !important;
        }

        /* Prevent text breakage */
        .poster-container * {
            overflow-wrap: break-word;
            word-wrap: break-word;
            word-break: normal;
        }

        /* Prevent image stretching globally */
        img {
            object-fit: cover !important;
            object-position: center center !important;
            width: 100%;
            height: 100%;
            display: block;
        }

        /* Utility Classes for Dynamic Colors */
        .text-primary { color: var(--primary) !important; }
        .text-secondary { color: var(--secondary) !important; }
        .bg-primary { background-color: var(--primary) !important; }
        .bg-secondary { background-color: var(--secondary) !important; }
        .border-primary { border-color: var(--primary) !important; }
        .border-secondary { border-color: var(--secondary) !important; }
        .bg-canvas { background-color: var(--bg) !important; }

        .loading-overlay {
            position: absolute; inset: 0; background: rgba(255,255,255,0.95);
            display: flex; align-items: center; justify-content: center; z-index: 50;
            backdrop-filter: blur(4px);
        }
    </style>
</head>
<body class="bg-gray-200 h-screen flex flex-col lg:flex-row overflow-hidden font-sans text-gray-800">

    <!-- LEFT SIDEBAR: Controls -->
    <div class="w-full lg:w-1/3 xl:w-1/4 bg-white border-r border-gray-300 flex flex-col h-full z-20 shadow-xl">
        <div class="p-4 border-b border-gray-200 bg-gray-900 text-white shadow-md flex justify-between items-center">
            <div>
                <h1 class="text-lg font-bold flex items-center"><i class="fas fa-palette mr-2 text-teal-400"></i>Poster Maker</h1>
                <p class="text-gray-400 text-[10px] mt-0.5 tracking-wide uppercase">Mama Watoto Home Care</p>
            </div>
            <button onclick="resetToDefaults()" class="text-xs bg-gray-700 hover:bg-gray-600 px-2 py-1 rounded transition text-white" title="Reset to Default"><i class="fas fa-undo"></i></button>
        </div>

        <!-- Tabs -->
        <div class="flex border-b border-gray-200 text-xs font-bold text-gray-500">
            <button onclick="switchTab('content')" id="tab-content" class="flex-1 py-3 text-teal-700 border-b-2 border-teal-600 bg-gray-50">Content</button>
            <button onclick="switchTab('design')" id="tab-design" class="flex-1 py-3 hover:text-teal-700 hover:bg-gray-50">Design & Colors</button>
            <button onclick="switchTab('layout')" id="tab-layout" class="flex-1 py-3 hover:text-teal-700 hover:bg-gray-50">Layouts</button>
        </div>

        <div class="flex-1 overflow-y-auto p-5 space-y-6 relative" id="sidebar-scroll">
            
            <!-- CONTENT TAB -->
            <div id="panel-content" class="space-y-4">
                
                <!-- Photos -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">1. Photos</label>
                    
                    <!-- Main Upload -->
                    <div class="flex items-center space-x-2 mb-2">
                        <label class="flex-1 cursor-pointer bg-teal-50 border border-teal-200 rounded px-3 py-2 hover:bg-teal-100 transition text-xs text-teal-800 font-bold truncate flex items-center justify-center shadow-sm">
                            <i class="fas fa-camera mr-2"></i> Upload Main Photo
                            <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(event, 0)">
                        </label>
                    </div>
                    
                    <div class="grid grid-cols-2 gap-2 mb-3">
                        <label class="cursor-pointer bg-white border border-gray-300 rounded px-2 py-2 hover:bg-gray-50 transition text-xs text-gray-600 truncate flex items-center justify-center shadow-sm">
                            <i class="fas fa-plus mr-1"></i> Photo 2
                            <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(event, 1)">
                        </label>
                        <label class="cursor-pointer bg-white border border-gray-300 rounded px-2 py-2 hover:bg-gray-50 transition text-xs text-gray-600 truncate flex items-center justify-center shadow-sm">
                            <i class="fas fa-plus mr-1"></i> Photo 3
                            <input type="file" accept="image/*" class="hidden" onchange="handleImageUpload(event, 2)">
                        </label>
                    </div>

                    <p class="text-[9px] text-gray-400 mb-1">Quick Select Stock:</p>
                    <div class="flex space-x-2 overflow-x-auto pb-2 scrollbar-hide">
                        <img onclick="setMainImage(this.src)" src="https://images.unsplash.com/photo-1503454537195-1dcabb73ffb9?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" class="w-10 h-10 rounded object-cover cursor-pointer hover:ring-2 hover:ring-teal-500 border border-gray-200">
                        <img onclick="setMainImage(this.src)" src="https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" class="w-10 h-10 rounded object-cover cursor-pointer hover:ring-2 hover:ring-teal-500 border border-gray-200">
                        <img onclick="setMainImage(this.src)" src="https://images.unsplash.com/photo-1542037104857-ffbb0b9155fb?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" class="w-10 h-10 rounded object-cover cursor-pointer hover:ring-2 hover:ring-teal-500 border border-gray-200">
                        <img onclick="setMainImage(this.src)" src="https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" class="w-10 h-10 rounded object-cover cursor-pointer hover:ring-2 hover:ring-teal-500 border border-gray-200">
                        <img onclick="setMainImage(this.src)" src="https://images.unsplash.com/photo-1476703993599-0035a21b17a9?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80" class="w-10 h-10 rounded object-cover cursor-pointer hover:ring-2 hover:ring-teal-500 border border-gray-200">
                    </div>
                </div>

                <hr class="border-gray-200">

                <!-- Text Details -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">2. Text Details</label>
                    
                    <input type="text" id="brandInput" value="Mama Watoto Home Care" placeholder="Brand Name" class="w-full p-2 border rounded text-xs focus:border-teal-500 outline-none font-bold text-gray-700 bg-white mb-2" oninput="updatePoster()">
                    
                    <!-- List Editor -->
                    <div class="bg-gray-50 p-2 rounded border border-gray-200 mb-3">
                        <div class="flex justify-between items-center mb-1">
                            <label class="text-[10px] text-gray-500 font-bold">List Content</label>
                            <select id="listSelect" onchange="changeListType()" class="p-1 border rounded text-[10px] focus:border-teal-500 outline-none bg-white">
                                <option value="roles">Our Roles</option>
                                <option value="values">Intro Text</option>
                            </select>
                        </div>
                        <textarea id="listEditor" oninput="updateListFromText()" class="w-full p-2 border rounded text-xs focus:border-teal-500 outline-none h-24 resize-none leading-relaxed text-gray-600 bg-white" style="display:block;"></textarea>
                    </div>

                    <!-- Slogan -->
                    <div class="mb-2">
                        <label class="text-[10px] text-gray-400 font-bold mb-1 block">Footer Slogan</label>
                        <select id="sloganSelect" onchange="updateSloganFromSelect()" class="w-full p-2 border rounded text-xs focus:border-teal-500 outline-none bg-white mb-1">
                            <option value="With patience, kindness and care">With patience, kindness and care</option>
                            <option value="A place parents trust. A place children love">A place parents trust. A place children love</option>
                            <option value="Where Little Hearts Are Cared For Like Family">Where Little Hearts Are Cared For Like Family</option>
                            <option value="Do you want to travel abroad and you feel like your kids are not in safe hands?">Do you want to travel abroad...</option>
                        </select>
                        <textarea id="customSlogan" oninput="updateSloganFromText()" placeholder="Custom slogan..." class="w-full p-2 border rounded text-xs focus:border-teal-500 outline-none h-12 resize-none text-gray-600"></textarea>
                    </div>

                    <!-- Contact -->
                    <div class="bg-blue-50 p-2 rounded border border-blue-100">
                        <p class="text-[10px] font-bold text-blue-400 uppercase mb-2">Contact Info</p>
                        <div class="space-y-1">
                            <input type="text" id="phoneInput" value="0720 594 968 - Judy" placeholder="Phone 1" class="w-full p-1.5 border rounded text-xs focus:border-blue-500 outline-none" oninput="updatePoster()">
                            <input type="text" id="phone2Input" value="0741 453 043 - Liz" placeholder="Phone 2" class="w-full p-1.5 border rounded text-xs focus:border-blue-500 outline-none" oninput="updatePoster()">
                            <input type="text" id="locationInput" value="Matangi (Biashara)" placeholder="Location" class="w-full p-1.5 border rounded text-xs focus:border-blue-500 outline-none" oninput="updatePoster()">
                            <div class="flex space-x-1">
                                <select id="socialTypeSelect" onchange="updatePoster()" class="w-1/3 p-1 border rounded text-[10px] bg-white">
                                    <option value="fab fa-whatsapp">WhatsApp</option>
                                    <option value="fab fa-facebook">FB</option>
                                    <option value="fab fa-instagram">Insta</option>
                                </select>
                                <input type="text" id="socialInput" placeholder="Handle" class="flex-1 p-1.5 border rounded text-xs" oninput="updatePoster()">
                            </div>
                            <input type="text" id="emailInput" placeholder="Email" class="w-full p-1.5 border rounded text-xs focus:border-blue-500 outline-none" oninput="updatePoster()">
                            <input type="text" id="webInput" placeholder="Website" class="w-full p-1.5 border rounded text-xs focus:border-blue-500 outline-none" oninput="updatePoster()">
                        </div>
                    </div>
                </div>
            </div>

            <!-- DESIGN TAB -->
            <div id="panel-design" class="space-y-6 hidden">
                <!-- Theme Colors -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">Colors</label>
                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Primary Color</label>
                            <div class="flex items-center space-x-2">
                                <input type="color" id="primaryColorPicker" value="#0f766e" oninput="updateTheme('primary', this.value)" class="w-8 h-8 rounded cursor-pointer border-none p-0">
                                <span id="primaryColorHex" class="text-xs font-mono text-gray-600">#0f766e</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Secondary Color</label>
                            <div class="flex items-center space-x-2">
                                <input type="color" id="secondaryColorPicker" value="#f97316" oninput="updateTheme('secondary', this.value)" class="w-8 h-8 rounded cursor-pointer border-none p-0">
                                <span id="secondaryColorHex" class="text-xs font-mono text-gray-600">#f97316</span>
                            </div>
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Background Base</label>
                            <div class="flex items-center space-x-2">
                                <input type="color" id="bgColorPicker" value="#ffffff" oninput="updateTheme('bg', this.value)" class="w-8 h-8 rounded cursor-pointer border-none p-0 border border-gray-200">
                                <span id="bgColorHex" class="text-xs font-mono text-gray-600">#ffffff</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Presets -->
                    <div class="mt-4">
                        <p class="text-[9px] text-gray-400 mb-2">Color Presets:</p>
                        <div class="flex flex-wrap gap-2">
                            <button onclick="setThemePreset('#0f766e', '#f97316', '#ffffff')" class="w-6 h-6 rounded-full bg-teal-700 border-2 border-orange-500 shadow-sm" title="Original"></button>
                            <button onclick="setThemePreset('#1e40af', '#fbbf24', '#eff6ff')" class="w-6 h-6 rounded-full bg-blue-800 border-2 border-yellow-400 shadow-sm" title="Professional Blue"></button>
                            <button onclick="setThemePreset('#831843', '#fbcfe8', '#fff1f2')" class="w-6 h-6 rounded-full bg-pink-900 border-2 border-pink-200 shadow-sm" title="Soft Pink"></button>
                            <button onclick="setThemePreset('#3f6212', '#a3e635', '#ecfccb')" class="w-6 h-6 rounded-full bg-lime-800 border-2 border-lime-400 shadow-sm" title="Nature Green"></button>
                            <button onclick="setThemePreset('#4c1d95', '#c4b5fd', '#f5f3ff')" class="w-6 h-6 rounded-full bg-violet-900 border-2 border-violet-300 shadow-sm" title="Royal Purple"></button>
                            <button onclick="setThemePreset('#1c1917', '#f59e0b', '#292524')" class="w-6 h-6 rounded-full bg-stone-900 border-2 border-amber-500 shadow-sm" title="Dark Mode"></button>
                        </div>
                    </div>
                </div>

                <hr class="border-gray-200">

                <!-- Fonts -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">Typography</label>
                    <div class="space-y-3">
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Heading Font</label>
                            <select id="headingFontSelect" onchange="updateTheme('fontHead', this.value)" class="w-full p-2 border rounded text-xs bg-white">
                                <option value="'Playfair Display', serif">Playfair Display (Elegant)</option>
                                <option value="'Montserrat', sans-serif">Montserrat (Modern)</option>
                                <option value="'Oswald', sans-serif">Oswald (Bold/Tall)</option>
                                <option value="'Dancing Script', cursive">Dancing Script (Cursive)</option>
                                <option value="'Fredoka', sans-serif">Fredoka (Friendly)</option>
                                <option value="'Chewy', cursive">Chewy (Playful)</option>
                                <option value="'Bangers', cursive">Bangers (Comic)</option>
                            </select>
                        </div>
                        <div>
                            <label class="text-[10px] text-gray-400 block mb-1">Body Font</label>
                            <select id="bodyFontSelect" onchange="updateTheme('fontBody', this.value)" class="w-full p-2 border rounded text-xs bg-white">
                                <option value="'Poppins', sans-serif">Poppins (Clean)</option>
                                <option value="'Nunito', sans-serif">Nunito (Rounded)</option>
                                <option value="'Raleway', sans-serif">Raleway (Elegant)</option>
                                <option value="'Quicksand', sans-serif">Quicksand (Soft)</option>
                                <option value="'Roboto Slab', serif">Roboto Slab (Formal)</option>
                                <option value="'Comic Neue', cursive">Comic Neue (Casual)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- LAYOUT TAB -->
            <div id="panel-layout" class="space-y-6 hidden">
                <!-- Size -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Canvas Size</label>
                    <div class="grid grid-cols-4 gap-2">
                        <button onclick="setRatio('portrait')" class="flex flex-col items-center justify-center p-2 border rounded hover:bg-gray-50 focus:ring-2 focus:ring-teal-500 transition">
                            <div class="w-3 h-4 border-2 border-gray-400 mb-1"></div>
                            <span class="text-[9px]">Poster</span>
                        </button>
                        <button onclick="setRatio('square')" class="flex flex-col items-center justify-center p-2 border rounded hover:bg-gray-50 focus:ring-2 focus:ring-teal-500 transition">
                            <div class="w-3 h-3 border-2 border-gray-400 mb-1"></div>
                            <span class="text-[9px]">Square</span>
                        </button>
                        <button onclick="setRatio('story')" class="flex flex-col items-center justify-center p-2 border rounded hover:bg-gray-50 focus:ring-2 focus:ring-teal-500 transition">
                            <div class="w-2.5 h-5 border-2 border-gray-400 mb-1"></div>
                            <span class="text-[9px]">Story</span>
                        </button>
                        <button onclick="setRatio('landscape')" class="flex flex-col items-center justify-center p-2 border rounded hover:bg-gray-50 focus:ring-2 focus:ring-teal-500 transition">
                            <div class="w-5 h-2.5 border-2 border-gray-400 mb-1"></div>
                            <span class="text-[9px]">Wide</span>
                        </button>
                    </div>
               </div>

               <!-- Templates -->
               <div>
                   <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-3">Templates</label>
                   <div class="grid grid-cols-2 gap-3">
                       <!-- The Classics -->
                       <button onclick="setTemplate(1)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">1. The Nurturer</button>
                       <button onclick="setTemplate(2)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">2. Values (Dark)</button>
                       <button onclick="setTemplate(3)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">3. Storyteller</button>
                       <button onclick="setTemplate(4)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">4. Mom's Heart</button>
                       <button onclick="setTemplate(5)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">5. Diaspora</button>
                       <button onclick="setTemplate(6)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">6. The Question</button>
                       <button onclick="setTemplate(7)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">7. Safe Hands</button>
                       <button onclick="setTemplate(8)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">8. Passport</button>
                       <button onclick="setTemplate(9)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">9. The Guardian</button>
                       <button onclick="setTemplate(10)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">10. Gentle Care</button>
                       <button onclick="setTemplate(11)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">11. Bright Future</button>
                       <button onclick="setTemplate(12)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">12. Peace of Mind</button>
                       <button onclick="setTemplate(13)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">13. Geometric</button>
                       <button onclick="setTemplate(14)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">14. Fluid Curves</button>
                       <button onclick="setTemplate(15)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">15. The Gallery</button>
                       <button onclick="setTemplate(16)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">16. Diagonal</button>
                       <button onclick="setTemplate(17)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">17. Little Hearts</button>
                       <button onclick="setTemplate(18)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">18. Trusted Care</button>
                       <button onclick="setTemplate(19)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">19. The Promise</button>
                       <button onclick="setTemplate(20)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">20. Second Home</button>
                       <button onclick="setTemplate(21)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">21. The Playground</button>
                       <button onclick="setTemplate(22)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">22. Sunny Day</button>
                       <button onclick="setTemplate(23)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">23. Art Class</button>
                       <button onclick="setTemplate(24)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">24. Building Blocks</button>
                       <button onclick="setTemplate(25)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">25. The Mosaic</button>
                       <button onclick="setTemplate(26)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">26. Soft Bubbles</button>
                       <button onclick="setTemplate(27)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">27. Sharp Edge</button>
                       <button onclick="setTemplate(28)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">28. Layered Cards</button>
                       <button onclick="setTemplate(29)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">29. Love & Care</button>
                       <button onclick="setTemplate(30)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">30. Little Star</button>
                       <button onclick="setTemplate(31)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">31. Puzzle Time</button>
                       <button onclick="setTemplate(32)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">32. Doodle Notebook</button>
                       <button onclick="setTemplate(33)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">33. Cloud Castle</button>
                       <button onclick="setTemplate(34)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">34. Flower Power</button>
                       <button onclick="setTemplate(35)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">35. Teddy Bear</button>
                       <button onclick="setTemplate(36)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">36. ABC Blocks</button>
                       <button onclick="setTemplate(37)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">37. Wonder World</button>
                       <button onclick="setTemplate(38)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">38. The Big Picture</button>
                       <button onclick="setTemplate(39)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">39. Comic Snap</button>
                       <button onclick="setTemplate(40)" class="p-2 border bg-white rounded hover:bg-teal-50 text-left text-[10px] font-medium">40. Cloud Dream</button>
                   </div>
               </div>
            </div>
        </div>

        <!-- Download Action -->
        <div class="p-5 border-t border-gray-200 bg-gray-50 flex flex-col space-y-2">
            <button onclick="downloadPoster()" id="downloadBtn" class="w-full bg-teal-700 hover:bg-teal-800 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition flex items-center justify-center transform active:scale-95">
                <i class="fas fa-download mr-2"></i> Download Image (PNG)
            </button>
            <button onclick="downloadPDF()" id="downloadPdfBtn" class="w-full bg-red-700 hover:bg-red-800 text-white font-bold py-3 px-4 rounded-lg shadow-md hover:shadow-lg transition flex items-center justify-center transform active:scale-95">
                <i class="fas fa-file-pdf mr-2"></i> Download PDF
            </button>
        </div>
    </div>

    <!-- RIGHT SIDE: Preview Canvas -->
    <div id="preview-area" class="flex-1 bg-gray-200/80 flex items-center justify-center relative overflow-hidden p-8">
        
        <!-- Zoom Controls -->
        <div class="absolute top-4 right-4 z-50 bg-white rounded-lg shadow-md flex items-center p-1 text-xs">
            <button onclick="adjustScale(-0.1)" class="w-6 h-6 hover:bg-gray-100 rounded">-</button>
            <span id="zoomLevel" class="w-10 text-center font-mono">Auto</span>
            <button onclick="adjustScale(0.1)" class="w-6 h-6 hover:bg-gray-100 rounded">+</button>
        </div>

        <!-- Loading Spinner -->
        <div id="loadingOverlay" class="loading-overlay hidden rounded-xl flex-col">
            <div class="w-12 h-12 border-4 border-teal-200 border-t-teal-600 rounded-full animate-spin mb-3"></div>
            <p class="font-bold text-gray-700 text-sm tracking-wide">GENERATING...</p>
            <p class="text-xs text-gray-400 mt-1">Please wait...</p>
        </div>

        <!-- The Poster Wrapper (Scaled) -->
        <div id="wrapper" class="poster-wrapper">
             <div id="posterArea" class="poster-container">
                <!-- Content injected via JS -->
            </div>
        </div>

    </div>

    <script>
        // --- DATA & STATE ---
        const stockImages = [
            "https://images.unsplash.com/photo-1503454537195-1dcabb73ffb9?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80",
            "https://images.unsplash.com/photo-1488521787991-ed7bbaae773c?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80",
            "https://images.unsplash.com/photo-1542037104857-ffbb0b9155fb?ixlib=rb-1.2.1&auto=format&fit=crop&w=800&q=80"
        ];
        
        let state = {
            templateId: 1, 
            ratio: 'portrait',
            images: [...stockImages], 
            phone: "0720 594 968 - Judy",
            phone2: "0741 453 043 - Liz",
            email: "",
            website: "",
            location: "Matangi (Biashara)",
            social: "",
            socialIcon: "fab fa-whatsapp",
            brandName: "Mama Watoto Home Care",
            slogan: "With patience, kindness and care",
            listType: "roles", // 'roles' or 'values'
            roles: [
                "Provide safe and loving care",
                "Meet basic daily needs",
                "Support learning and development",
                "Offer emotional support",
                "Work in partnership with parent",
                "Teach values and good behaviour",
                "Support health and well-being",
                "Maintain clean and organized environment"
            ],
            values: [
                "A home filled with warmth and understanding",
                "Caring hands, loving hearts",
                "Where children feel safe, valued and happy",
                "More than care - a second home"
            ],
            // Theme State
            primaryColor: "#0f766e",
            secondaryColor: "#f97316",
            bgColor: "#fffbf0",
            fontHeading: "'Playfair Display', serif",
            fontBody: "'Poppins', sans-serif"
        };

        // --- INIT ---
        window.onload = function() {
            // Set initial inputs
            document.getElementById('brandInput').value = state.brandName;
            document.getElementById('phoneInput').value = state.phone;
            document.getElementById('phone2Input').value = state.phone2;
            document.getElementById('locationInput').value = state.location;
            document.getElementById('socialInput').value = state.social;
            document.getElementById('socialTypeSelect').value = state.socialIcon;
            document.getElementById('sloganSelect').value = state.slogan;
            document.getElementById('customSlogan').value = state.slogan; 
            document.getElementById('listSelect').value = state.listType;
            
            // Set Color Pickers
            document.getElementById('primaryColorPicker').value = state.primaryColor;
            document.getElementById('secondaryColorPicker').value = state.secondaryColor;
            document.getElementById('bgColorPicker').value = state.bgColor;
            
            // Init List Editor
            updateListEditorContent();

            renderPoster();
            initResizeObserver();
        };

        // --- TABS & UI ---
        function switchTab(tabName) {
            ['content', 'design', 'layout'].forEach(t => {
                document.getElementById(`panel-${t}`).classList.add('hidden');
                document.getElementById(`tab-${t}`).classList.remove('text-teal-700', 'border-b-2', 'border-teal-600', 'bg-gray-50');
            });
            document.getElementById(`panel-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('text-teal-700', 'border-b-2', 'border-teal-600', 'bg-gray-50');
        }

        function updateStateFromInputs() {
            state.brandName = document.getElementById('brandInput')?.value || 'Mama Watoto Home Care';
            state.phone = document.getElementById('phoneInput')?.value || '';
            state.phone2 = document.getElementById('phone2Input')?.value || '';
            state.email = document.getElementById('emailInput')?.value || '';
            state.website = document.getElementById('webInput')?.value || '';
            state.location = document.getElementById('locationInput')?.value || '';
            state.social = document.getElementById('socialInput')?.value || '';
            state.socialIcon = document.getElementById('socialTypeSelect')?.value || 'fab fa-whatsapp';
            state.listType = document.getElementById('listSelect')?.value || 'roles';
        }

        // --- SCALING LOGIC (ADAPTIVE) ---
        let manualScale = null;

        function initResizeObserver() {
            const ro = new ResizeObserver(entries => {
                if(!manualScale) autoFitPreview();
            });
            ro.observe(document.getElementById('preview-area'));
            window.addEventListener('resize', () => {
                if(!manualScale) autoFitPreview();
            });
        }

        function autoFitPreview() {
            const area = document.getElementById('preview-area');
            const wrapper = document.getElementById('wrapper');
            
            // Base dimensions for high-res output
            let baseWidth, baseHeight;
            
            if (state.ratio === 'portrait') { baseWidth = 800; baseHeight = 1066; }
            else if (state.ratio === 'square') { baseWidth = 800; baseHeight = 800; }
            else if (state.ratio === 'landscape') { baseWidth = 1200; baseHeight = 675; }
            else if (state.ratio === 'story') { baseWidth = 600; baseHeight = 1066; }

            // Set actual pixel size of wrapper
            wrapper.style.width = baseWidth + 'px';
            wrapper.style.height = baseHeight + 'px';

            // Calculate scale
            const margin = 40; // padding around preview
            const availableWidth = area.clientWidth - margin;
            const availableHeight = area.clientHeight - margin;
            
            const scaleX = availableWidth / baseWidth;
            const scaleY = availableHeight / baseHeight;
            const scale = Math.min(scaleX, scaleY, 1.0); // Max scale 1

            // Apply translate and scale
            wrapper.style.transform = `translate(-50%, -50%) scale(${scale})`;
            
            // Update UI
            document.getElementById('zoomLevel').innerText = Math.round(scale * 100) + '%';
        }

        function adjustScale(delta) {
            const currentText = document.getElementById('zoomLevel').innerText;
            let currentScale = parseFloat(currentText) / 100;
            if(isNaN(currentScale)) currentScale = 0.5; // fallback
            
            manualScale = currentScale + delta;
            if (manualScale < 0.1) manualScale = 0.1;
            
            const wrapper = document.getElementById('wrapper');
            wrapper.style.transform = `translate(-50%, -50%) scale(${manualScale})`;
            document.getElementById('zoomLevel').innerText = Math.round(manualScale * 100) + '%';
        }

        // --- THEME LOGIC ---
        function updateTheme(key, value) {
            if(key === 'primary') {
                state.primaryColor = value;
                document.getElementById('primaryColorHex').innerText = value;
            } else if (key === 'secondary') {
                state.secondaryColor = value;
                document.getElementById('secondaryColorHex').innerText = value;
            } else if (key === 'bg') {
                state.bgColor = value;
                document.getElementById('bgColorHex').innerText = value;
            } else if (key === 'fontHead') {
                state.fontHeading = value;
            } else if (key === 'fontBody') {
                state.fontBody = value;
            }
            renderPoster();
        }

        function setThemePreset(p, s, bg) {
            state.primaryColor = p;
            state.secondaryColor = s;
            state.bgColor = bg;
            
            document.getElementById('primaryColorPicker').value = p;
            document.getElementById('primaryColorHex').innerText = p;
            document.getElementById('secondaryColorPicker').value = s;
            document.getElementById('secondaryColorHex').innerText = s;
            document.getElementById('bgColorPicker').value = bg;
            document.getElementById('bgColorHex').innerText = bg;
            
            renderPoster();
        }

        function resetToDefaults() {
            setThemePreset("#0f766e", "#f97316", "#fffbf0");
            state.fontHeading = "'Playfair Display', serif";
            state.fontBody = "'Poppins', sans-serif";
            document.getElementById('headingFontSelect').value = state.fontHeading;
            document.getElementById('bodyFontSelect').value = state.fontBody;
            renderPoster();
        }

        // --- OTHER INPUT LOGIC ---
        function updateSloganFromSelect() {
            const select = document.getElementById('sloganSelect');
            const textarea = document.getElementById('customSlogan');
            state.slogan = select.value;
            textarea.value = select.value; 
            renderPoster();
        }

        function updateSloganFromText() {
            const textarea = document.getElementById('customSlogan');
            state.slogan = textarea.value;
            renderPoster();
        }

        function updateListEditorContent() {
             const editor = document.getElementById('listEditor');
             const list = state.listType === 'roles' ? state.roles : state.values;
             editor.value = list.join('\n');
        }

        function changeListType() {
            updateStateFromInputs();
            updateListEditorContent(); // Refresh textarea with new list type data
            renderPoster();
        }

        function updateListFromText() {
            const editor = document.getElementById('listEditor');
            const lines = editor.value.split('\n').filter(line => line.trim() !== '');
            if(state.listType === 'roles') {
                state.roles = lines;
            } else {
                state.values = lines;
            }
            renderPoster();
        }

        function updatePoster() {
            updateStateFromInputs();
            renderPoster();
        }

        function setTemplate(id) {
            state.templateId = id;
            renderPoster();
        }

        function setRatio(ratio) {
            state.ratio = ratio;
            renderPoster();
            autoFitPreview(); // Recalculate scale on ratio change
        }

        function setMainImage(src) {
            state.images[0] = src;
            renderPoster();
        }

        function handleImageUpload(event, index) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    state.images[index] = e.target.result;
                    renderPoster();
                }
                reader.readAsDataURL(file);
            }
        }

        // --- HELPER: GET CURRENT LIST ---
        function getActiveList() {
            return state.listType === 'roles' ? state.roles : state.values;
        }

        // --- HELPER: RENDER CONTACT INFO BLOCK ---
        function renderContactDetails(textColorClass = 'text-gray-600', iconColorClass = 'text-teal-600', layout = 'col') {
            // NOTE: textColorClass is overridden by CSS variables if custom colors are active, 
            // but for structure we keep the layout argument.
            
            // We use generic classes here that map to variables in the CSS
            // If layout is 'row', we use flex-row
            let html = `<div class="flex ${layout === 'row' ? 'flex-row flex-wrap gap-4 justify-center' : 'flex-col gap-1'} text-[1.25rem] leading-tight" style="color: var(--text-main)">`;
            
            // Use specific colors for icons if needed, e.g. secondary color
            const iconStyle = `color: var(--secondary)`;
            
            if(state.phone) html += `<div class="flex items-center gap-2"><i class="fas fa-phone w-4" style="${iconStyle}"></i><span>${state.phone}</span></div>`;
            if(state.phone2) html += `<div class="flex items-center gap-2"><i class="fas fa-phone-alt w-4" style="${iconStyle}"></i><span>${state.phone2}</span></div>`;
            if(state.email) html += `<div class="flex items-center gap-2"><i class="fas fa-envelope w-4" style="${iconStyle}"></i><span>${state.email}</span></div>`;
            if(state.website) html += `<div class="flex items-center gap-2"><i class="fas fa-globe w-4" style="${iconStyle}"></i><span>${state.website}</span></div>`;
            if(state.location) html += `<div class="flex items-center gap-2"><i class="fas fa-map-marker-alt w-4" style="${iconStyle}"></i><span>${state.location}</span></div>`;
            if(state.social) html += `<div class="flex items-center gap-2"><i class="${state.socialIcon} w-4" style="${iconStyle}"></i><span>${state.social}</span></div>`;

            html += `</div>`;
            return html;
        }

        // --- RENDER LOGIC ---
        function renderPoster() {
            try {
                const container = document.getElementById('posterArea');
                const activeList = getActiveList();
                
                // Update CSS Variables for Theming
                container.style.setProperty('--primary', state.primaryColor);
                container.style.setProperty('--secondary', state.secondaryColor);
                container.style.setProperty('--bg', state.bgColor);
                container.style.setProperty('--font-head', state.fontHeading.split(',')[0].replace(/'/g, ""));
                container.style.setProperty('--font-body', state.fontBody.split(',')[0].replace(/'/g, ""));
                
                // Helper styles
                const bgPrimary = `background-color: var(--primary)`;
                const bgSecondary = `background-color: var(--secondary)`;
                const bgBase = `background-color: var(--bg)`;
                const textPrimary = `color: var(--primary)`;
                const textSecondary = `color: var(--secondary)`;
                const textBase = `color: var(--text-main)`;
                const borderPrimary = `border-color: var(--primary)`;

                // Common HTML parts
                const listItems = activeList.map(item => `<div class="flex items-center text-[1.4rem] mb-1" style="${textBase}"><div class="w-1.5 h-1.5 rounded-full mr-3 flex-shrink-0" style="${bgSecondary}"></div><span class="leading-tight">${item}</span></div>`).join('');
                
                let html = '';

                // --- TEMPLATES (Refactored to use Variables) ---
                
                if (state.templateId === 1) {
                    html = `<div class="h-full flex flex-col relative" style="${bgBase}">
                        <div class="h-[35%] relative overflow-hidden flex-shrink-0">
                            <img src="${state.images[0]}" class="w-full h-full object-cover">
                            <div class="absolute bottom-0 left-0 w-full h-24" style="background: linear-gradient(to top, var(--bg), transparent)"></div>
                        </div>
                        <div class="flex-1 px-8 pb-8 relative -mt-8 flex flex-col z-10">
                            <div class="rounded-3xl p-8 shadow-xl border flex-1 flex flex-col justify-center bg-white" style="border-color: var(--secondary)">
                                <h1 class="text-5xl font-bold mb-2 leading-none text-center" style="${textPrimary}">${state.brandName}</h1>
                                <p class="text-[1.2rem] tracking-[0.2em] uppercase font-bold mb-6 text-center" style="${textSecondary}">Home Care Services</p>
                                <p class="text-xl italic mb-8 text-center text-gray-500">"${state.slogan}"</p>
                                <div class="grid grid-cols-1 gap-2 text-left mb-6 overflow-hidden">
                                    ${listItems}
                                </div>
                                <div class="mt-auto pt-6 border-t border-gray-100 flex justify-center">
                                    ${renderContactDetails('', '', 'row')}
                                </div>
                            </div>
                        </div>
                    </div>`;
                } 
                else if (state.templateId === 2) {
                    html = `<div class="h-full relative flex flex-col bg-black">
                        <div class="absolute inset-0">
                            <img src="${state.images[0]}" class="w-full h-full object-cover opacity-60">
                            <div class="absolute inset-0 mix-blend-multiply" style="${bgPrimary}"></div>
                            <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-black/60"></div>
                        </div>
                        <div class="relative z-10 h-full flex flex-col justify-between p-8 text-center text-white">
                            <div class="mt-4 flex-shrink-0">
                                <h1 class="text-2xl tracking-[0.3em] uppercase opacity-90 border-b border-white/30 inline-block pb-2 font-bold">${state.brandName}</h1>
                            </div>
                            <div class="my-auto flex-shrink-0">
                                <i class="fas fa-heart text-4xl mb-4 opacity-80" style="${textSecondary}"></i>
                                <h2 class="text-4xl leading-tight mb-6 drop-shadow-lg font-bold">${state.slogan}</h2>
                                <div class="text-left px-6 border-l-4 ml-4" style="border-color: var(--secondary)">
                                    ${activeList.map(item => `<p class="text-[1.5rem] font-light opacity-90 mb-2">â€¢ ${item}</p>`).join('')}
                                </div>
                            </div>
                            <div class="mb-4 flex-shrink-0 mt-6">
                                <div class="inline-block bg-white/10 backdrop-blur-md border border-white/30 px-8 py-4 rounded-xl">
                                    ${renderContactDetails('text-white font-bold', '', 'col')}
                                </div>
                            </div>
                        </div>
                    </div>`;
                }
                else if (state.templateId === 3) {
                    html = `<div class="h-full relative flex flex-col text-white" style="background-color: #111827">
                        <div class="absolute inset-0"><img src="${state.images[0]}" class="w-full h-full object-cover">
                        <div class="absolute inset-0" style="background: linear-gradient(to right, rgba(0,0,0,0.95), rgba(0,0,0,0.6), transparent)"></div></div>
                        <div class="relative z-10 h-full w-2/3 p-8 flex flex-col justify-between">
                        <div class="flex-shrink-0"><div class="w-10 h-1 mb-4" style="${bgPrimary}"></div>
                        <h1 class="text-5xl font-black leading-tight mb-2 uppercase">${state.brandName}</h1>
                        <p class="text-[1.2rem] uppercase tracking-widest" style="${textSecondary}">Home Care</p></div>
                        <div class="my-auto flex-shrink-0"><h2 class="text-2xl font-bold italic mb-4 opacity-90">"${state.slogan}"</h2>
                        <div class="space-y-3 border-l-2 pl-4" style="border-color: rgba(255,255,255,0.2)">${activeList.map(item => `<p class="text-[1.4rem] font-light text-gray-200">${item}</p>`).join('')}</div></div>
                        <div class="flex-shrink-0 bg-black/40 p-3 rounded-lg backdrop-blur-sm">${renderContactDetails('text-gray-300', '', 'col')}</div></div></div>`;
                }
                else if (state.templateId === 4) {
                    html = `<div class="h-full flex flex-col relative" style="${bgBase}"><div class="h-1/2 relative"><img src="${state.images[0]}" class="w-full h-full object-cover">
                    <div class="absolute bottom-0 w-full h-1/2" style="background: linear-gradient(to top, var(--bg), transparent)"></div></div>
                    <div class="flex-1 px-6 pb-6 flex flex-col text-center relative z-10 -mt-10"><div class="bg-white p-6 rounded-2xl shadow-xl flex-1 flex flex-col">
                    <h1 class="text-4xl font-bold mb-2" style="${textPrimary}">${state.brandName}</h1><div class="w-12 h-1 mx-auto mb-4" style="background-color: var(--secondary); opacity: 0.3"></div>
                    <p class="text-lg font-medium text-gray-700 mb-auto italic">"${state.slogan}"</p>
                    <div class="text-left mt-4 mb-4 p-4 rounded-xl" style="background-color: rgba(0,0,0,0.03)">${activeList.map(item => `<div class="flex items-start mb-1"><i class="fas fa-heart text-[10px] mt-1 mr-2" style="${textSecondary}"></i><span class="text-[1.3rem] text-gray-600">${item}</span></div>`).join('')}</div>
                    <div class="border-t border-gray-100 pt-3">${renderContactDetails('text-gray-500', '', 'row')}</div></div></div></div>`;
                }
                else if (state.templateId === 5) {
                    html = `<div class="h-full flex flex-col relative overflow-hidden text-white" style="background-color: #0f172a">
                    <div class="p-6 pb-2 flex-shrink-0 z-10"><div class="border-l-4 pl-4" style="border-color: var(--secondary)">
                    <p class="text-sm uppercase tracking-widest font-bold mb-1" style="color: var(--secondary)">Attention Parents Abroad</p>
                    <h1 class="text-4xl font-bold leading-tight uppercase">${state.brandName}</h1></div></div>
                    <div class="relative h-1/3 w-full my-2 flex-shrink-0"><img src="${state.images[0]}" class="w-full h-full object-cover" style="mask-image: linear-gradient(to bottom, black 80%, transparent 100%)"></div>
                    <div class="px-6 flex-1 flex flex-col z-10"><p class="text-2xl italic mb-4 leading-snug" style="color: #bfdbfe">"${state.slogan}"</p>
                    <div class="grid grid-cols-1 gap-2 mb-auto">${activeList.map(item => `<div class="flex items-center bg-white/5 p-2 rounded border border-white/10"><div class="w-1.5 h-1.5 rounded-full mr-3" style="${bgSecondary}"></div><span class="text-[1.2rem] font-medium">${item}</span></div>`).join('')}</div>
                    <div class="mt-4 pt-4 border-t border-white/10"><p class="text-sm text-gray-400 uppercase mb-2">Contact Judy & Liz Today:</p>${renderContactDetails('text-white font-bold', '', 'col')}</div></div></div>`;
                }
                else if (state.templateId === 6) {
                    html = `<div class="h-full flex flex-col" style="${bgBase}"><div class="text-white p-6 flex-shrink-0 relative overflow-hidden" style="${bgPrimary}">
                    <i class="fas fa-question absolute -right-4 -top-4 text-9xl opacity-20"></i><h1 class="text-5xl font-black uppercase tracking-wide relative z-10 leading-none">${state.brandName}</h1>
                    <p class="text-sm uppercase tracking-widest relative z-10">Home Care Services</p></div>
                    <div class="p-6 flex-1 flex flex-col justify-center"><div class="mb-6"><i class="fas fa-quote-left text-4xl mb-2" style="color: var(--secondary); opacity: 0.5"></i>
                    <h2 class="text-3xl font-bold text-gray-800 leading-tight">${state.slogan}</h2></div>
                    <div class="flex items-center gap-4 mb-6"><div class="w-24 h-24 rounded-full overflow-hidden border-4 flex-shrink-0" style="border-color: var(--secondary)"><img src="${state.images[0]}" class="w-full h-full object-cover"></div>
                    <div class="flex-1"><p class="text-lg font-bold text-gray-700 mb-1">Our Promise:</p>${activeList.map(i => `<p class="text-[1.1rem] text-gray-500">â€¢ ${i}</p>`).join('')}</div></div>
                    <div class="bg-white p-4 border-l-4 shadow-sm mt-auto" style="border-color: var(--primary)">${renderContactDetails('text-gray-700', '', 'col')}</div></div></div>`;
                }
                else if (state.templateId === 7) {
                    html = `<div class="h-full flex flex-col p-4 border-8 border-white" style="${bgBase}"><div class="bg-white p-4 shadow-sm flex-1 flex flex-col">
                    <div class="text-center mb-4"><h1 class="text-5xl font-bold leading-none" style="${textPrimary}">${state.brandName}</h1><p class="text-sm uppercase tracking-widest" style="${textSecondary}">Home Care Services</p></div>
                    <div class="relative w-full aspect-square mb-4 rounded-full overflow-hidden border-4" style="border-color: rgba(0,0,0,0.05)"><img src="${state.images[0]}" class="w-full h-full object-cover"></div>
                    <div class="p-4 rounded-xl text-center mb-auto" style="background-color: rgba(0,0,0,0.03)"><i class="fas fa-quote-left mb-2" style="${textSecondary}"></i>
                    <p class="text-lg italic text-gray-600 leading-relaxed mb-2">${state.slogan}</p><div class="border-t mt-2 pt-2" style="border-color: rgba(0,0,0,0.1)">${activeList.map(i => `<p class="text-[1.2rem] font-bold uppercase" style="${textPrimary}">${i}</p>`).join('')}</div></div>
                    <div class="mt-4 pt-4 border-t border-gray-100 text-center">${renderContactDetails('text-gray-600', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 8) {
                    html = `<div class="h-full p-6 text-white flex flex-col" style="background-color: #312e81"><div class="border-2 border-yellow-500/30 p-4 h-full flex flex-col relative">
                    <div class="absolute top-2 right-2 border-2 border-red-400 rounded-full w-20 h-20 flex items-center justify-center rotate-12 opacity-50"><p class="text-[10px] text-red-400 font-bold uppercase text-center leading-tight">Verified<br>Safe<br>Care</p></div>
                    <h1 class="text-4xl font-bold mb-1 leading-none uppercase" style="color: #eab308">${state.brandName}</h1><h2 class="text-lg font-light text-white mb-6">Home Care Services</h2>
                    <div class="w-40 h-48 bg-gray-200 self-center mb-6 p-1 bg-white transform -rotate-2 shadow-lg"><img src="${state.images[0]}" class="w-full h-full object-cover grayscale contrast-125"></div>
                    <div class="mb-auto"><p class="text-lg font-mono text-yellow-100 mb-4 leading-relaxed border-l-2 border-yellow-500 pl-3">"${state.slogan}"</p>
                    <div class="space-y-1">${activeList.map(i => `<div class="flex items-center gap-2 text-[1.2rem] text-gray-400"><i class="fas fa-check text-green-500"></i> ${i}</div>`).join('')}</div></div>
                    <div class="mt-6 border-t border-white/20 pt-4">${renderContactDetails('text-gray-300', '', 'col')}</div></div></div>`;
                }
                else if (state.templateId === 9) {
                    html = `<div class="h-full flex flex-col" style="${bgBase}"><div class="relative h-[50%] w-full"><img src="${state.images[0]}" class="w-full h-full object-cover"><div class="absolute inset-0" style="background: linear-gradient(to top, var(--bg), transparent)"></div>
                    <div class="absolute bottom-4 left-6"><div class="text-xs font-bold px-3 py-1 uppercase tracking-widest inline-block mb-2" style="${bgSecondary}">Trusted & Verified</div>
                    <h1 class="text-4xl font-bold leading-none uppercase" style="${textPrimary}">${state.brandName.replace(/ /g, '<br>')}</h1></div></div>
                    <div class="flex-1 p-6 flex flex-col"><p class="text-lg font-light italic mb-4">"${state.slogan}"</p>
                    <div class="mb-auto grid grid-cols-1 gap-2">${activeList.map(item => `<div class="flex items-center text-[1.3rem]"><div class="w-1.5 h-1.5 mr-2" style="${bgSecondary}"></div>${item}</div>`).join('')}</div>
                    <div class="border-t pt-4 mt-4" style="border-color: rgba(0,0,0,0.1)">${renderContactDetails('', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 10) {
                    html = `<div class="h-full p-6 flex flex-col items-center text-center" style="${bgBase}"><div class="w-full h-[40%] rounded-t-[100px] overflow-hidden mb-6 relative shadow-lg"><img src="${state.images[0]}" class="w-full h-full object-cover"><div class="absolute inset-0 border-[8px] border-white/30 rounded-t-[100px]"></div></div>
                    <h1 class="text-4xl font-bold mb-2 leading-none" style="${textPrimary}">${state.brandName}</h1><p class="text-sm uppercase tracking-widest mb-6" style="${textSecondary}">Home Care Services</p>
                    <div class="relative mb-auto text-left w-full px-4"><p class="text-lg font-medium italic relative z-10 mb-4 text-center">"${state.slogan}"</p>
                    <div class="space-y-1 border-l-2 pl-3" style="border-color: var(--secondary)">${activeList.map(i => `<p class="text-[1.2rem]">${i}</p>`).join('')}</div></div>
                    <div class="w-full bg-white p-4 rounded-xl shadow-sm border mt-4" style="border-color: rgba(0,0,0,0.05)">${renderContactDetails('', '', 'row')}</div></div>`;
                }
                else if (state.templateId === 11) {
                    html = `<div class="h-full relative flex flex-col" style="${bgPrimary}"><div class="absolute inset-0"><img src="${state.images[0]}" class="w-full h-full object-cover"><div class="absolute inset-0 mix-blend-multiply" style="${bgSecondary}"></div><div class="absolute inset-0" style="background: linear-gradient(to top, #000, transparent)"></div></div>
                    <div class="relative z-10 h-full p-8 flex flex-col justify-between text-white"><div class="border-l-4 border-white pl-4"><h1 class="text-5xl font-black uppercase leading-none mb-1">${state.brandName}</h1><p class="text-sm font-medium opacity-90">Professional Home Care</p></div>
                    <div class="text-center"><h2 class="text-2xl font-bold mb-4 leading-snug drop-shadow-md">"${state.slogan}"</h2><div class="bg-black/20 backdrop-blur-md p-4 rounded-lg border border-white/20 text-left mb-4">${activeList.map(i => `<p class="text-[1.3rem] text-white/90 mb-1">â€¢ ${i}</p>`).join('')}</div>
                    <div class="bg-white p-2 rounded shadow-lg" style="${textPrimary}">${renderContactDetails('', '', 'row')}</div></div></div></div>`;
                }
                else if (state.templateId === 12) {
                    html = `<div class="h-full flex flex-col" style="${bgBase}"><div class="flex-1 p-6 flex flex-col relative z-10"><h1 class="text-3xl font-bold mb-1 uppercase leading-none" style="${textPrimary}">${state.brandName}</h1>
                    <p class="text-xs uppercase font-bold tracking-widest mb-6" style="${textSecondary}">For Parents Abroad</p><h2 class="text-xl font-bold text-gray-800 leading-tight mb-4">${state.slogan}</h2>
                    <div class="space-y-2 mb-6 overflow-y-auto">${activeList.map(item => `<div class="flex items-center bg-white p-2 rounded shadow-sm border-l-4" style="border-color: var(--secondary)"><i class="fas fa-check-circle mr-2 flex-shrink-0" style="${textPrimary}"></i><span class="text-[1.2rem] font-medium leading-tight">${item}</span></div>`).join('')}</div>
                    <div class="mt-auto"><p class="text-sm uppercase text-gray-400 font-bold mb-2">Reach out to us:</p>${renderContactDetails('', '', 'col')}</div></div>
                    <div class="h-1/3 relative flex-shrink-0"><img src="${state.images[0]}" class="w-full h-full object-cover"><div class="absolute top-0 left-0 w-full h-12" style="background: linear-gradient(to bottom, var(--bg), transparent)"></div></div></div>`;
                }
                else if (state.templateId === 13) {
                    html = `<div class="h-full relative overflow-hidden flex flex-col justify-center items-center p-6" style="${bgBase}">
                    <div class="absolute top-0 right-0 w-64 h-64 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 opacity-20" style="${bgPrimary}"></div>
                    <div class="relative z-10 w-full mb-6"><div class="flex justify-center items-center -space-x-4">
                    <div class="w-24 h-24 rounded-2xl rotate-12 overflow-hidden border-4 border-white shadow-lg z-0 relative transform translate-y-2"><img src="${state.images[1] || state.images[0]}" class="w-full h-full object-cover rotate-[-12deg] scale-125"></div>
                    <div class="w-32 h-32 rounded-2xl rotate-45 overflow-hidden border-4 border-white shadow-xl z-10 relative"><img src="${state.images[0]}" class="w-full h-full object-cover rotate-[-45deg] scale-125"></div>
                    <div class="w-24 h-24 rounded-2xl -rotate-12 overflow-hidden border-4 border-white shadow-lg z-0 relative transform translate-y-2"><img src="${state.images[2] || state.images[0]}" class="w-full h-full object-cover rotate-[12deg] scale-125"></div></div></div>
                    <div class="relative z-10 text-center bg-white/80 backdrop-blur-sm p-6 rounded-2xl shadow-sm border border-white w-full"><h1 class="text-3xl font-bold mb-1" style="${textPrimary}">${state.brandName}</h1>
                    <p class="text-sm italic mb-4 leading-relaxed">"${state.slogan}"</p><div class="grid grid-cols-2 gap-1 mb-4 text-left">${activeList.map(i => `<p class="text-[1.1rem]" style="${textSecondary}">â€¢ ${i}</p>`).join('')}</div>
                    <div class="pt-4 border-t" style="border-color: rgba(0,0,0,0.1)">${renderContactDetails('', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 14) {
                    html = `<div class="h-full flex flex-col p-6" style="${bgBase}"><div class="flex justify-between items-center mb-6"><h1 class="text-3xl font-black uppercase leading-none" style="${textPrimary}">${state.brandName}</h1><div class="text-xs font-bold px-3 py-1 rounded-full text-white" style="${bgSecondary}">Verified</div></div>
                    <div class="relative flex-1 mb-6 flex items-center justify-center"><div class="w-64 h-64 overflow-hidden border-4 border-white shadow-lg relative z-10" style="border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%;"><img src="${state.images[0]}" class="w-full h-full object-cover"></div>
                    <div class="absolute w-60 h-60 rounded-full blur-xl z-0 transform translate-x-2 translate-y-2 opacity-30" style="${bgPrimary}"></div>
                    <div class="absolute -bottom-4 -right-2 bg-white p-3 rounded-lg shadow-md z-20 transform -rotate-6 max-w-[200px]"><p class="text-[10px] font-bold mb-1" style="${textSecondary}">We Provide:</p>${activeList.slice(0,4).map(i => `<p class="text-[10px] truncate">- ${i}</p>`).join('')}</div></div>
                    <div class="bg-white rounded-xl p-4 shadow-sm border-l-4" style="border-color: var(--secondary)"><p class="text-sm font-medium mb-2">"${state.slogan}"</p>${renderContactDetails('', '', 'row')}</div></div>`;
                }
                else if (state.templateId === 15) {
                    html = `<div class="h-full flex flex-col p-4 bg-white m-4 shadow-xl"><div class="text-center mb-4 pb-4 border-b border-gray-100"><h1 class="text-3xl font-serif tracking-wide uppercase leading-none" style="${textPrimary}">${state.brandName}</h1><p class="text-xs uppercase tracking-[0.3em]" style="${textSecondary}">The Art of Care</p></div>
                    <div class="flex-1 grid grid-cols-2 gap-2 mb-4"><div class="col-span-2 h-40 relative group overflow-hidden"><img src="${state.images[0]}" class="w-full h-full object-cover transition duration-500 group-hover:scale-105"></div>
                    <div class="h-32 relative group overflow-hidden"><img src="${state.images[1] || state.images[0]}" class="w-full h-full object-cover transition duration-500 group-hover:scale-105"></div>
                    <div class="h-32 relative group overflow-hidden"><img src="${state.images[2] || state.images[0]}" class="w-full h-full object-cover transition duration-500 group-hover:scale-105"></div></div>
                    <div class="p-3 text-center mb-auto" style="${bgBase}"><p class="text-sm italic mb-2">"${state.slogan}"</p><div class="flex flex-wrap justify-center gap-2">${activeList.map(i => `<span class="bg-white border border-gray-200 px-2 py-1 rounded text-[1.1rem]">${i}</span>`).join('')}</div></div>
                    <div class="mt-4 text-center">${renderContactDetails('', '', 'row')}</div></div>`;
                }
                else if (state.templateId === 16) {
                    html = `<div class="h-full relative overflow-hidden flex flex-col" style="${bgBase}"><div class="absolute top-0 right-0 w-2/3 h-full transform -skew-x-12 translate-x-12 z-0" style="${bgSecondary}"></div>
                    <div class="relative z-10 h-1/2 p-6 flex flex-col justify-center"><h1 class="text-5xl font-black text-white drop-shadow-lg uppercase italic leading-none mb-2">${state.brandName}</h1><div class="bg-white inline-block px-3 py-1 transform -skew-x-12 self-start"><p class="text-sm font-bold uppercase transform skew-x-12" style="${textPrimary}">Professional Care</p></div></div>
                    <div class="relative z-10 flex-1 flex items-end justify-end p-6"><div class="p-4 text-right transform -skew-x-12 border-l-4 border-white shadow-2xl max-w-[90%]" style="background-color: rgba(0,0,0,0.8)"><div class="transform skew-x-12"><p class="text-sm text-white font-medium mb-2 leading-tight">"${state.slogan}"</p>
                    <div class="text-[1.1rem] text-gray-400 mb-4 border-t border-gray-700 pt-2">${activeList.map(i => `<div>${i}</div>`).join('')}</div><div class="text-white">${renderContactDetails('', '', 'col')}</div></div></div></div>
                    <div class="absolute top-1/4 right-8 w-40 h-40 border-4 border-white shadow-2xl transform rotate-3 z-0 overflow-hidden"><img src="${state.images[0]}" class="w-full h-full object-cover"></div></div>`;
                }
                else if (state.templateId === 17) {
                    html = `<div class="h-full flex flex-col p-4" style="${bgBase}"><div class="border-4 h-full flex flex-col bg-white relative" style="border-color: var(--secondary)">
                    <div class="absolute top-0 left-1/2 -translate-x-1/2 -translate-y-1/2 text-white px-4 py-1 rounded-full text-sm font-bold uppercase tracking-widest shadow-md" style="${bgPrimary}">Family Care</div>
                    <div class="p-8 pb-4 text-center"><h1 class="text-4xl font-bold mb-2 leading-none" style="${textSecondary}">${state.brandName}</h1><p class="text-sm text-gray-500">"Where Little Hearts Are Cared For Like Family"</p></div>
                    <div class="px-6 flex-1 flex flex-col"><div class="rounded-xl p-4 mb-4" style="${bgBase}"><h3 class="text-center text-sm font-bold mb-2 uppercase" style="${textPrimary}">Our Promise</h3>
                    <div class="space-y-2">${activeList.map(item => `<div class="flex items-start text-[1.2rem]"><i class="fas fa-heart mt-0.5 mr-2 text-[10px]" style="${textSecondary}"></i><span class="leading-tight">${item}</span></div>`).join('')}</div></div>
                    <div class="mt-auto mb-4"><div class="h-40 rounded-xl overflow-hidden relative"><img src="${state.images[0]}" class="w-full h-full object-cover"></div></div>
                    <div class="text-center border-t pt-4 mb-4" style="border-color: rgba(0,0,0,0.1)">${renderContactDetails('', '', 'row')}</div></div></div></div>`;
                }
                else if (state.templateId === 18) {
                    html = `<div class="h-full flex flex-col" style="${bgBase}"><div class="text-white p-6 rounded-b-[40px] shadow-lg relative z-10" style="${bgPrimary}"><div class="flex justify-between items-end">
                    <div><h1 class="text-3xl font-bold uppercase leading-none">${state.brandName}</h1><p class="text-xs uppercase tracking-widest opacity-80">Gentle, Trusted Care</p></div><i class="fas fa-child text-4xl opacity-50"></i></div></div>
                    <div class="px-6 -mt-6 relative z-20 mb-4"><div class="bg-white p-1 rounded-full shadow-md w-28 h-28 mx-auto border-4 border-white"><img src="${state.images[0]}" class="w-full h-full object-cover rounded-full"></div></div>
                    <div class="flex-1 px-6 pb-6 flex flex-col"><div class="text-center mb-4"><p class="text-sm font-bold" style="${textPrimary}">"${state.slogan}"</p></div>
                    <div class="bg-white rounded-lg p-4 shadow-sm border flex-1" style="border-color: rgba(0,0,0,0.05)"><ul class="space-y-2">${activeList.map(item => `<li class="flex items-start text-[1.2rem]"><div class="min-w-[6px] h-[6px] rounded-full mt-1.5 mr-2" style="${bgSecondary}"></div><span class="leading-tight">${item}</span></li>`).join('')}</ul></div>
                    <div class="mt-4 text-center">${renderContactDetails('', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 19) {
                    html = `<div class="h-full flex flex-col text-white relative" style="${bgPrimary}"><div class="absolute inset-0"><img src="${state.images[0]}" class="w-full h-full object-cover opacity-20 grayscale"></div>
                    <div class="relative z-10 h-full p-8 flex flex-col border-8 border-white/10 m-4"><div class="text-center mb-8"><h1 class="text-4xl font-serif italic mb-1 leading-none">${state.brandName}</h1><div class="w-16 h-0.5 mx-auto" style="${bgSecondary}"></div></div>
                    <div class="flex-1 flex flex-col justify-center"><h2 class="text-2xl font-bold mb-6 text-center leading-snug">"${state.slogan}"</h2><div class="grid grid-cols-1 gap-3">${activeList.map(item => `<div class="bg-white/10 p-2 rounded backdrop-blur-sm border-l-2" style="border-color: var(--secondary)"><p class="text-[1.3rem] font-light tracking-wide">${item}</span></div>`).join('')}</div></div>
                    <div class="mt-auto text-center pt-6">${renderContactDetails('text-white', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 20) {
                    html = `<div class="h-full flex flex-col" style="${bgBase}"><div class="h-1/2 relative"><img src="${state.images[0]}" class="w-full h-full object-cover"><div class="absolute inset-0 bg-gradient-to-t from-black/80 to-transparent"></div><div class="absolute bottom-6 left-6 text-white"><h1 class="text-4xl font-bold">A Second Home.</h1><p class="text-sm opacity-90">${state.slogan.substring(0, 40)}...</p></div></div>
                    <div class="flex-1 bg-white p-6 flex flex-col relative"><div class="absolute -top-6 right-6 w-14 h-14 rounded-full flex items-center justify-center shadow-lg text-white text-xl" style="${bgSecondary}"><i class="fas fa-home"></i></div>
                    <div class="flex-1 overflow-y-auto mt-2"><h3 class="text-sm font-bold uppercase mb-3 border-b pb-1" style="border-color: rgba(0,0,0,0.1); ${textPrimary}">What We Provide</h3><div class="space-y-3">${activeList.map(item => `<div class="flex items-center text-[1.2rem]"><i class="fas fa-star text-[10px] mr-2" style="${textSecondary}"></i>${item}</div>`).join('')}</div></div>
                    <div class="mt-4 pt-4 border-t-2 border-dashed border-gray-100">${renderContactDetails('', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 21) {
                    html = `<div class="h-full p-6 flex flex-col relative overflow-hidden" style="${bgBase}"><div class="absolute top-0 right-0 w-32 h-32 rounded-bl-full z-0 opacity-20" style="${bgSecondary}"></div><div class="absolute bottom-0 left-0 w-24 h-24 rounded-tr-full z-0 opacity-20" style="${bgPrimary}"></div>
                    <div class="relative z-10 text-center mb-4"><h1 class="text-4xl font-black drop-shadow-sm tracking-wide leading-none" style="${textPrimary}">${state.brandName}</h1><div class="bg-white inline-block px-3 py-1 rounded-full border-2 mt-2" style="border-color: var(--secondary)"><p class="text-sm font-bold uppercase" style="${textSecondary}">Fun & Safe Care</p></div></div>
                    <div class="relative z-10 mb-4 p-2 bg-white rounded-3xl border-4 border-dashed transform -rotate-1 shadow-md" style="border-color: var(--secondary)"><div class="h-48 rounded-2xl overflow-hidden"><img src="${state.images[0]}" class="w-full h-full object-cover"></div></div>
                    <div class="flex-1 bg-white/90 backdrop-blur rounded-2xl p-4 border-4 relative z-10 shadow-lg" style="border-color: var(--primary)"><p class="text-sm font-bold text-center mb-4 leading-tight">"${state.slogan}"</p><div class="space-y-1">${activeList.map(item => `<div class="flex items-center"><div class="w-2 h-2 rounded-full mr-2 flex-shrink-0" style="${bgSecondary}"></div><p class="text-[1.2rem] font-bold">${item}</p></div>`).join('')}</div></div>
                    <div class="relative z-10 mt-4 text-center">${renderContactDetails('', '', 'row')}</div></div>`;
                }
                else if (state.templateId === 22) {
                    html = `<div class="h-full flex flex-col relative overflow-hidden" style="${bgBase}"><div class="absolute top-10 left-10 w-16 h-8 bg-white rounded-full opacity-80"></div><div class="absolute top-12 left-16 w-12 h-10 bg-white rounded-full opacity-80"></div>
                    <div class="relative z-10 p-6 flex flex-col h-full"><div class="bg-white/80 p-4 rounded-3xl shadow-lg text-center mb-6 backdrop-blur-sm border-2 border-white"><h1 class="text-4xl font-bold leading-none" style="${textPrimary}">${state.brandName}</h1><p class="text-sm font-bold uppercase tracking-widest" style="${textSecondary}">Home Care</p></div>
                    <div class="flex-1 flex flex-col items-center"><div class="w-56 h-56 rounded-full border-8 border-white shadow-xl overflow-hidden mb-6"><img src="${state.images[0]}" class="w-full h-full object-cover"></div>
                    <div class="bg-white p-4 rounded-xl border-2 shadow-md w-full" style="border-color: var(--secondary)"><p class="text-sm text-center font-bold mb-2">"${state.slogan}"</p><div class="flex justify-center gap-2"><span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold shadow-sm">Play</span><span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold shadow-sm">Learn</span><span class="bg-gray-100 px-2 py-1 rounded text-xs font-bold shadow-sm">Grow</span></div></div></div>
                    <div class="mt-auto pt-4 text-center">${renderContactDetails('', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 23) {
                    html = `<div class="h-full p-6 flex flex-col" style="${bgBase}"><div class="border-4 border-dashed h-full p-4 flex flex-col bg-white shadow-xl relative" style="border-color: var(--primary)">
                    <div class="absolute -top-3 left-1/2 -translate-x-1/2 w-32 h-8 rotate-2 shadow-sm" style="${bgSecondary}"></div>
                    <h1 class="text-5xl text-center font-bold mt-4 mb-2 leading-none" style="${textPrimary}">${state.brandName}</h1>
                    <div class="transform rotate-2 border-4 border-white shadow-lg mb-6 bg-gray-100 p-1"><img src="${state.images[0]}" class="w-full h-48 object-cover"></div>
                    <p class="text-2xl text-center font-bold mb-4 leading-none" style="${textSecondary}">"${state.slogan}"</p>
                    <ul class="text-sm space-y-1 pl-4 list-disc">${activeList.map(i => `<li>${i}</li>`).join('')}</ul>
                    <div class="mt-auto border-t-2 border-dotted pt-4 text-center" style="border-color: #ccc">${renderContactDetails('', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 24) {
                    html = `<div class="h-full flex flex-col p-4 gap-4" style="${bgBase}"><div class="flex gap-2 h-1/4"><div class="flex-1 rounded-lg flex items-center justify-center shadow-md" style="${bgPrimary}"><h1 class="text-white font-black text-2xl text-center leading-tight uppercase">${state.brandName.replace(/ /g, '<br>')}</h1></div>
                    <div class="w-1/3 rounded-lg flex items-center justify-center shadow-md" style="${bgSecondary}"><i class="fas fa-home text-white text-4xl"></i></div></div>
                    <div class="h-1/3 p-2 rounded-lg shadow-md border-4" style="background-color: #fef08a; border-color: #facc15"><div class="w-full h-full bg-white rounded overflow-hidden"><img src="${state.images[0]}" class="w-full h-full object-cover"></div></div>
                    <div class="flex-1 bg-white rounded-lg p-4 border-4 shadow-md flex flex-col" style="border-color: var(--primary)"><p class="text-sm font-bold mb-2 text-center" style="${textPrimary}">"${state.slogan}"</p>
                    <div class="space-y-1 mb-auto">${activeList.map(i => `<div class="bg-gray-100 px-2 py-1 rounded text-[1.1rem] font-bold shadow-sm">${i}</div>`).join('')}</div>
                    <div class="mt-2 pt-2 border-t text-center" style="border-color: #eee">${renderContactDetails('', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 25) {
                    // Mosaic Grid Layout
                    html = `<div class="h-full p-4 flex flex-col" style="${bgBase}">
                        <div class="flex-1 grid grid-cols-6 grid-rows-6 gap-2 mb-4">
                            <div class="col-span-4 row-span-4 rounded-3xl overflow-hidden relative shadow-lg"><img src="${state.images[0]}" class="w-full h-full object-cover"></div>
                            <div class="col-span-2 row-span-3 rounded-2xl overflow-hidden relative shadow-md mt-8"><img src="${state.images[1] || state.images[0]}" class="w-full h-full object-cover"></div>
                            <div class="col-span-3 row-span-2 col-start-4 row-start-4 rounded-2xl overflow-hidden relative shadow-md -ml-8 border-4 border-white z-10"><img src="${state.images[2] || state.images[0]}" class="w-full h-full object-cover"></div>
                            <div class="col-span-4 row-span-2 col-start-1 row-start-5 rounded-2xl p-4 flex flex-col justify-center text-white shadow-xl z-20" style="${bgPrimary}">
                                <h1 class="text-2xl font-bold uppercase leading-none">${state.brandName}</h1><p class="text-xs opacity-80 leading-tight mt-1">"${state.slogan}"</p></div>
                        </div>
                        <div class="bg-white p-3 rounded-xl border flex items-center justify-between" style="border-color: var(--secondary)">
                            <div><p class="text-xs font-bold uppercase" style="${textSecondary}">Trusted By Families</p><div class="flex -space-x-1 mt-1"><div class="w-4 h-4 rounded-full bg-gray-200 border border-white"></div><div class="w-4 h-4 rounded-full bg-gray-300 border border-white"></div></div></div>
                            ${renderContactDetails('', '', 'col')}</div></div>`;
                }
                else if (state.templateId === 26) {
                    // Soft Bubbles
                    html = `<div class="h-full relative overflow-hidden flex flex-col justify-center items-center p-6" style="${bgBase}">
                        <div class="absolute top-0 left-0 w-64 h-64 rounded-full blur-3xl -translate-x-1/2 -translate-y-1/2 opacity-30" style="${bgPrimary}"></div>
                        <div class="relative z-10 w-full mb-6 flex flex-col items-center">
                            <div class="w-56 h-56 mb-[-20px] relative z-10 shadow-xl" style="border-radius: 40% 60% 70% 30% / 40% 50% 60% 50%; overflow: hidden; border: 4px solid white;"><img src="${state.images[0]}" class="w-full h-full object-cover"></div>
                            <div class="flex justify-between w-full px-4 -mt-4">
                                <div class="w-28 h-28 shadow-lg transform -translate-y-4" style="border-radius: 60% 40% 30% 70% / 60% 30% 70% 40%; overflow: hidden; border: 3px solid white;"><img src="${state.images[1] || state.images[0]}" class="w-full h-full object-cover"></div>
                                <div class="w-24 h-24 shadow-lg transform translate-y-2" style="border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; overflow: hidden; border: 3px solid white;"><img src="${state.images[2] || state.images[0]}" class="w-full h-full object-cover"></div>
                            </div>
                        </div>
                        <div class="bg-white/80 backdrop-blur-md rounded-2xl p-6 text-center shadow-sm w-full border relative z-20" style="border-color: var(--secondary)">
                            <h1 class="text-3xl font-bold mb-2 leading-none" style="${textPrimary}">${state.brandName}</h1>
                            <p class="text-sm font-medium italic mb-4">"${state.slogan}"</p>
                            <div class="border-t pt-3" style="border-color: rgba(0,0,0,0.1)">${renderContactDetails('', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 27) {
                    html = `<div class="h-full flex flex-col relative" style="background-color: #1e1b4b">
                        <div class="h-1/3 w-full relative overflow-hidden"><div class="absolute inset-0 transform -skew-y-6 origin-top-left overflow-hidden h-[120%] -mt-4 border-b-4" style="border-color: var(--secondary)"><img src="${state.images[0]}" class="w-full h-full object-cover transform skew-y-6 scale-110"></div></div>
                        <div class="flex-1 p-6 relative z-10 flex flex-col justify-center">
                            <div class="flex gap-2 mb-4"><div class="w-1/2 h-24 overflow-hidden rounded-lg border-2 transform rotate-2" style="border-color: var(--primary)"><img src="${state.images[1] || state.images[0]}" class="w-full h-full object-cover"></div>
                            <div class="w-1/2 h-24 overflow-hidden rounded-lg border-2 transform -rotate-2 mt-4" style="border-color: var(--primary)"><img src="${state.images[2] || state.images[0]}" class="w-full h-full object-cover"></div></div>
                            <h1 class="text-4xl font-black text-white uppercase leading-none mb-2">${state.brandName.split(' ')[0]}<br><span style="${textSecondary}">${state.brandName.split(' ').slice(1).join(' ')}</span></h1>
                            <p class="text-sm text-indigo-200 font-medium mb-4">"${state.slogan}"</p>
                            <div class="p-3 rounded border-l-4" style="background-color: rgba(255,255,255,0.1); border-color: var(--secondary)">${renderContactDetails('text-indigo-100', '', 'col')}</div></div></div>`;
                }
                else if (state.templateId === 28) {
                    html = `<div class="h-full p-8 flex flex-col justify-center relative" style="${bgBase}">
                        <div class="absolute top-10 left-10 right-6 bottom-20 rounded-3xl transform rotate-3 shadow-sm" style="${bgSecondary}"></div>
                        <div class="relative bg-white rounded-3xl p-5 shadow-2xl flex flex-col h-full max-h-[90%] transform -rotate-1 border border-stone-200">
                            <div class="flex justify-between items-center mb-4"><div class="w-3 h-3 rounded-full" style="${bgPrimary}"></div><h1 class="text-2xl font-bold leading-none">${state.brandName}</h1></div>
                            <div class="grid grid-cols-2 gap-2 mb-4"><div class="col-span-2 h-40 rounded-xl overflow-hidden border border-stone-100"><img src="${state.images[0]}" class="w-full h-full object-cover"></div>
                            <div class="h-24 rounded-xl overflow-hidden border border-stone-100"><img src="${state.images[1] || state.images[0]}" class="w-full h-full object-cover"></div><div class="h-24 rounded-xl overflow-hidden border border-stone-100"><img src="${state.images[2] || state.images[0]}" class="w-full h-full object-cover"></div></div>
                            <p class="text-sm font-medium text-center mb-auto">"${state.slogan}"</p>
                            <div class="mt-4 pt-4 border-t-2 border-dashed border-stone-200 text-center">${renderContactDetails('', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 29) {
                     // Love Heart
                     html = `<div class="h-full flex flex-col p-4 relative" style="${bgBase}"><div class="absolute top-0 right-0 w-32 h-32 rounded-bl-full z-0 opacity-50" style="${bgSecondary}"></div>
                     <div class="relative z-10 flex flex-col items-center h-full"><div class="text-center mt-4 mb-4"><h1 class="text-4xl drop-shadow-sm leading-none" style="${textPrimary}">${state.brandName}</h1><p class="text-sm font-bold">Made with Love</p></div>
                     <div class="w-72 h-72 relative mb-4"><div class="w-full h-full" style="clip-path: path('M50,90 C10,60 -10,30 20,10 C35,-5 50,20 50,20 C50,20 65,-5 80,10 C110,30 90,60 50,90 Z'); background-color: white;"><img src="${state.images[0]}" class="w-full h-full object-cover"></div></div>
                     <div class="bg-white rounded-2xl p-4 shadow-lg border-2 text-center w-full max-w-xs" style="border-color: var(--secondary)"><p class="text-sm mb-2">"${state.slogan}"</p>
                     <div class="flex flex-wrap justify-center gap-1">${activeList.map(i => `<span class="text-[1.2rem] px-2 py-1 rounded-full font-bold text-white" style="${bgPrimary}">${i}</span>`).join('')}</div></div>
                     <div class="mt-auto mb-2 w-full text-center">${renderContactDetails('', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 30) {
                     // Star Shape
                     html = `<div class="h-full flex flex-col p-4 relative overflow-hidden" style="background-color: #312e81">
                     <div class="absolute top-10 left-10 text-yellow-300 text-xl animate-pulse">â˜…</div><div class="absolute top-20 right-20 text-yellow-200 text-xs">â˜…</div><div class="relative z-10 flex flex-col items-center h-full text-white">
                     <div class="mt-4 mb-2 text-center"><h1 class="text-4xl tracking-wider leading-none" style="color: #facc15">SUPER STARS</h1><p class="text-sm uppercase tracking-widest">${state.brandName}</p></div>
                     <div class="w-72 h-72 relative mb-4 flex items-center justify-center"><div class="w-full h-full relative" style="clip-path: polygon(50% 0%, 61% 35%, 98% 35%, 68% 57%, 79% 91%, 50% 70%, 21% 91%, 32% 57%, 2% 35%, 39% 35%); background-color: white;"><img src="${state.images[0]}" class="w-full h-full object-cover"></div></div>
                     <div class="bg-white/10 backdrop-blur-md rounded-xl p-4 border border-yellow-400/30 text-center w-full"><p class="text-sm italic mb-3">"${state.slogan}"</p><div class="grid grid-cols-2 gap-2 text-left">${activeList.map(i => `<div class="text-[1.2rem]">â˜… ${i}</div>`).join('')}</div></div>
                     <div class="mt-auto w-full text-center border-t border-indigo-800 pt-4">${renderContactDetails('text-yellow-400', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 31) {
                     html = `<div class="h-full p-4 flex flex-col" style="${bgBase}"><div class="text-center mb-4"><h1 class="text-4xl leading-none" style="${textPrimary}">${state.brandName}</h1><div class="flex justify-center gap-1 mt-1"><div class="w-3 h-3 bg-red-400 rounded"></div><div class="w-3 h-3 bg-yellow-400 rounded"></div><div class="w-3 h-3 bg-green-400 rounded"></div></div></div>
                     <div class="flex-1 relative"><div class="absolute top-0 left-0 w-40 h-40 z-10 overflow-hidden" style="mask-image: radial-gradient(circle at 100% 50%, transparent 10px, black 11px);"><div class="w-full h-full border-4 border-white shadow-md p-1" style="${bgSecondary}"><img src="${state.images[0]}" class="w-full h-full object-cover rounded"></div></div>
                     <div class="absolute top-20 right-4 w-40 h-40 z-20 transform rotate-3"><div class="w-full h-full border-4 border-white shadow-lg p-1 rounded-lg" style="${bgPrimary}"><img src="${state.images[1] || state.images[0]}" class="w-full h-full object-cover rounded"></div></div>
                     <div class="absolute bottom-0 w-full bg-white rounded-2xl p-4 shadow-xl border-t-4" style="border-color: var(--primary)"><p class="text-sm font-bold text-gray-700 text-center mb-2">"${state.slogan}"</p><div class="flex flex-wrap justify-center gap-2">${activeList.map(i => `<span class="text-[1.1rem] px-2 py-1 rounded font-bold border" style="${textPrimary}; border-color: var(--primary)">${i}</span>`).join('')}</div></div></div><div class="mt-4 pt-2 text-center">${renderContactDetails('', '', 'row')}</div></div>`;
                }
                else if (state.templateId === 32) {
                     html = `<div class="h-full p-6 flex flex-col relative" style="${bgBase}"><div class="absolute top-0 left-4 w-4 h-full border-l-4 border-dotted border-gray-400 z-0"></div><div class="relative z-10 ml-6 flex flex-col h-full">
                     <div class="transform -rotate-2 mb-4"><h1 class="text-5xl font-bold leading-none" style="text-shadow: 2px 2px 0px #ccc; ${textPrimary}">${state.brandName}</h1></div>
                     <div class="border-4 border-black rounded-lg p-2 bg-white transform rotate-1 mb-4 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)]"><div class="h-48 overflow-hidden bg-gray-100 border-2 border-dashed border-gray-300"><img src="${state.images[0]}" class="w-full h-full object-cover"></div></div>
                     <div class="p-4 transform -rotate-1 shadow-sm border border-yellow-200" style="background-color: #fef9c3"><p class="text-lg leading-tight">"${state.slogan}"</p></div>
                     <ul class="mt-4 space-y-2 text-sm list-disc pl-4">${activeList.map(i => `<li>${i}</li>`).join('')}</ul>
                     <div class="mt-auto pt-4 border-t-2 border-black border-dashed">${renderContactDetails('', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 33) {
                     html = `<div class="h-full flex flex-col p-4 relative overflow-hidden" style="background-color: #7dd3fc"><div class="absolute top-10 right-10 w-24 h-12 bg-white rounded-full opacity-60"></div><div class="absolute bottom-20 left-5 w-20 h-10 bg-white rounded-full opacity-60"></div>
                     <div class="text-center z-10 mt-4"><h1 class="text-5xl text-white drop-shadow-md tracking-wider leading-none">${state.brandName}</h1></div>
                     <div class="flex-1 flex flex-col justify-center items-center gap-4 z-10 relative"><div class="w-56 h-40 bg-white p-2 shadow-lg relative" style="border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;"><div class="w-full h-full overflow-hidden" style="border-radius: 50% 50% 50% 50% / 60% 60% 40% 40%;"><img src="${state.images[0]}" class="w-full h-full object-cover"></div></div>
                     <div class="flex gap-4"><div class="w-28 h-28 bg-white p-1 shadow-md relative" style="border-radius: 50%;"><div class="w-full h-full overflow-hidden rounded-full"><img src="${state.images[1] || state.images[0]}" class="w-full h-full object-cover"></div></div><div class="w-28 h-28 bg-white p-1 shadow-md relative" style="border-radius: 50%;"><div class="w-full h-full overflow-hidden rounded-full"><img src="${state.images[2] || state.images[0]}" class="w-full h-full object-cover"></div></div></div></div>
                     <div class="bg-white rounded-xl p-4 shadow-lg text-center z-10 border-4 border-white"><p class="text-sm font-bold mb-2" style="${textPrimary}">"${state.slogan}"</p>${renderContactDetails('text-gray-600', '', 'row')}</div></div>`;
                }
                else if (state.templateId === 34) {
                     html = `<div class="h-full flex flex-col p-4 items-center justify-center relative" style="${bgBase}"><div class="w-72 h-72 relative mb-6 z-10"><div class="absolute inset-0" style="clip-path: path('M50,20 a15,15 0 0,1 0,30 a15,15 0 0,1 0,-30 M80,50 a15,15 0 0,1 -30,0 a15,15 0 0,1 30,0 M50,80 a15,15 0 0,1 0,-30 a15,15 0 0,1 0,30 M20,50 a15,15 0 0,1 30,0 a15,15 0 0,1 -30,0'); background-color: var(--primary);"></div><img src="${state.images[0]}" class="w-full h-full object-cover absolute inset-0" style="clip-path: circle(35% at 50% 50%)"></div>
                     <div class="text-center z-10 mb-4"><h1 class="text-4xl leading-none" style="${textPrimary}">${state.brandName}</h1><p class="text-sm font-bold" style="${textSecondary}">Nurturing Growth</p></div>
                     <div class="bg-white/80 p-4 rounded-lg shadow-sm text-center w-full border-2" style="border-color: var(--secondary)"><p class="text-sm mb-3">"${state.slogan}"</p><div class="flex flex-wrap justify-center gap-1">${activeList.map(i => `<span class="text-[1.1rem] font-bold" style="${textPrimary}">âœ¿ ${i}</span>`).join('')}</div></div>
                     <div class="mt-auto pt-4 text-center">${renderContactDetails('', '', 'row')}</div></div>`;
                }
                else if (state.templateId === 35) {
                     html = `<div class="h-full flex flex-col p-6 items-center" style="${bgBase}"><div class="w-full bg-white rounded-[2rem] p-4 shadow-xl border-4 relative flex-1 flex flex-col" style="border-color: var(--secondary)"><div class="absolute -top-6 left-10 w-12 h-12 rounded-full z-0" style="${bgSecondary}"></div><div class="absolute -top-6 right-10 w-12 h-12 rounded-full z-0" style="${bgSecondary}"></div>
                     <div class="relative z-10 text-center mb-4 mt-2"><h1 class="text-4xl font-bold leading-none" style="${textPrimary}">${state.brandName}</h1></div>
                     <div class="w-48 h-48 mx-auto rounded-full overflow-hidden border-4 mb-4 shadow-inner" style="border-color: var(--bg)"><img src="${state.images[0]}" class="w-full h-full object-cover"></div>
                     <div class="p-3 rounded-xl mb-auto text-center" style="${bgPrimary}"><p class="text-sm font-bold mb-2 text-white">"${state.slogan}"</p><div class="text-left pl-2">${activeList.map(i => `<p class="text-[1.2rem] text-white">ðŸ¾ ${i}</p>`).join('')}</div></div>
                     <div class="mt-4 pt-3 border-t-2 border-dashed text-center" style="border-color: var(--secondary)">${renderContactDetails('', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 36) {
                     const firstWord = state.brandName.split(' ')[0] || "MAMA";
                     const letters = firstWord.substring(0,4).split('');
                     const colors = ['#ef4444', '#3b82f6', '#22c55e', '#eab308'];
                     
                     html = `<div class="h-full flex flex-col p-4" style="${bgBase}"><div class="flex justify-center gap-1 mb-4">
                        ${letters.map((l, i) => `<div class="w-12 h-12 rounded text-white flex items-center justify-center font-black text-2xl shadow-md font-fredoka" style="background-color: ${colors[i % 4]}">${l.toUpperCase()}</div>`).join('')}
                     </div><div class="border-4 p-1 rounded-lg bg-white shadow-lg mb-4 transform rotate-1" style="border-color: var(--primary)"><div class="h-48 bg-gray-200"><img src="${state.images[0]}" class="w-full h-full object-cover"></div></div>
                     <div class="flex-1 bg-white border-l-8 pl-4 py-2 shadow-sm mb-4" style="border-color: var(--secondary)"><h2 class="text-lg font-bold uppercase mb-2">Why Choose Us?</h2><div class="space-y-1">${activeList.map((i, idx) => `<p class="text-[1.1rem] font-bold" style="color: ${colors[idx % 4]}">${i}</p>`).join('')}</div></div>
                     <div class="mt-auto p-2 rounded-lg text-center shadow-lg text-white" style="background-color: #1f2937">${renderContactDetails('text-white font-bold', '', 'row')}</div></div>`;
                }
                else if (state.templateId === 37) {
                    html = `<div class="h-full w-full relative flex flex-col"><div class="absolute inset-0 z-0"><img src="${state.images[0]}" class="w-full h-full object-cover"></div>
                    <div class="relative z-10 mt-auto m-4 bg-white/90 backdrop-blur-sm rounded-3xl p-6 shadow-2xl border-4" style="border-color: var(--primary)"><h1 class="text-4xl font-black mb-2 drop-shadow-sm leading-none" style="${textPrimary}">${state.brandName}</h1>
                    <p class="text-lg font-bold text-gray-700 leading-tight mb-4">"${state.slogan}"</p><div class="flex gap-2 mb-4 justify-center"><span class="bg-yellow-400 text-white text-sm font-bold px-3 py-1 rounded-full shadow-sm">Safe</span><span class="bg-pink-400 text-white text-sm font-bold px-3 py-1 rounded-full shadow-sm">Fun</span></div>
                    <div class="pt-2 border-t-2 border-gray-100 text-center">${renderContactDetails('text-gray-600 font-bold', '', 'row')}</div></div></div>`;
                }
                else if (state.templateId === 38) {
                    html = `<div class="h-full flex flex-col" style="${bgBase}"><div class="h-[85%] relative p-2"><div class="w-full h-full rounded-[2rem] overflow-hidden shadow-lg border-4 border-white relative group"><img src="${state.images[0]}" class="w-full h-full object-cover">
                    <div class="absolute top-4 right-4 text-white font-black text-2xl px-4 py-2 rounded-full transform rotate-6 shadow-md border-2 border-white" style="${bgSecondary}">${state.brandName.split(' ')[0]}!</div>
                    <div class="absolute bottom-6 left-6 right-6 bg-black/60 backdrop-blur-md p-4 rounded-xl text-center"><p class="text-white text-sm font-bold leading-snug">"${state.slogan}"</p></div></div></div>
                    <div class="flex-1 flex items-center justify-center text-white" style="${bgPrimary}">${renderContactDetails('text-white font-bold', '', 'row')}</div></div>`;
                }
                else if (state.templateId === 39) {
                    html = `<div class="h-full p-4 flex flex-col" style="background-image: radial-gradient(circle, var(--secondary) 20%, transparent 20%); background-size: 10px 10px; background-color: var(--bg);">
                    <div class="bg-white border-[6px] border-black h-full flex flex-col p-2 shadow-[8px_8px_0px_0px_rgba(0,0,0,1)] relative"><div class="absolute -top-6 -left-4 text-white font-black text-3xl px-4 py-1 border-4 border-black transform -rotate-6 shadow-[4px_4px_0px_0px_rgba(0,0,0,1)] z-20" style="${bgSecondary}">SUPER!</div>
                    <div class="flex-1 border-4 border-black overflow-hidden relative mb-2"><img src="${state.images[0]}" class="w-full h-full object-cover"><div class="absolute bottom-4 right-4 bg-white border-4 border-black p-3 rounded-2xl rounded-br-none max-w-[70%] shadow-[4px_4px_0px_0px_rgba(0,0,0,0.5)]"><p class="text-sm font-bold text-black leading-tight">"${state.slogan}"</p></div></div>
                    <div class="border-4 border-black p-2 text-center" style="${bgPrimary}"><h1 class="text-3xl font-black text-white tracking-wide leading-none" style="text-shadow: 2px 2px 0 #000">${state.brandName}</h1><div class="mt-1 bg-white border-2 border-black p-1 inline-block rounded">${renderContactDetails('text-black font-bold text-[10px]', '', 'row')}</div></div></div></div>`;
                }
                else if (state.templateId === 40) {
                    html = `<div class="h-full flex flex-col relative overflow-hidden" style="${bgBase}"><div class="absolute top-[-50px] right-[-50px] w-40 h-40 rounded-full border-4 opacity-80 z-0" style="border-color: var(--secondary); ${bgPrimary}"></div>
                    <div class="h-[75%] w-full relative z-10" style="filter: drop-shadow(0 10px 10px rgba(0,0,0,0.1));"><div class="w-full h-full bg-white relative" style="clip-path: ellipse(130% 100% at 50% 0%);"><img src="${state.images[0]}" class="w-full h-full object-cover"></div>
                    <div class="absolute bottom-10 left-0 right-0 text-center"><h1 class="text-5xl text-white drop-shadow-lg leading-none" style="text-shadow: 2px 2px 0 var(--primary)">${state.brandName}</h1></div></div>
                    <div class="flex-1 flex flex-col justify-center items-center text-center px-6 pb-4 z-10"><p class="font-bold text-lg mb-4 leading-snug drop-shadow-md" style="${textPrimary}">"${state.slogan}"</p>
                    <div class="bg-white/20 backdrop-blur-md rounded-full px-6 py-2 border border-white/40">${renderContactDetails('font-bold', '', 'row')}</div></div></div>`;
                }

                container.innerHTML = html;
                
                // Trigger auto fit after render
                setTimeout(autoFitPreview, 100);

            } catch (err) {
                console.error("Render error:", err);
                document.getElementById('posterArea').innerHTML = `<div class="p-10 text-center text-red-500">Error rendering template.</div>`;
            }
        }

        // --- Export Helper: Replace IMG with DIV for object-fit support in html2canvas ---
        function polyfillImages(clonedDoc) {
            const images = clonedDoc.getElementsByTagName('img');
            Array.from(images).forEach(img => {
                const rect = img.getBoundingClientRect();
                const div = clonedDoc.createElement('div');
                div.className = img.className; // Keep existing classes
                
                // Copy critical styles
                const computedStyle = window.getComputedStyle(img);
                div.style.width = '100%'; 
                div.style.height = '100%';
                div.style.position = computedStyle.position;
                div.style.top = computedStyle.top;
                div.style.left = computedStyle.left;
                div.style.right = computedStyle.right;
                div.style.bottom = computedStyle.bottom;
                div.style.transform = computedStyle.transform;
                div.style.zIndex = computedStyle.zIndex;
                div.style.borderRadius = computedStyle.borderRadius;
                div.style.clipPath = computedStyle.clipPath;
                div.style.maskImage = computedStyle.maskImage;
                
                // The magic for exact fit
                div.style.backgroundImage = `url(${img.src})`;
                div.style.backgroundSize = 'cover';
                div.style.backgroundPosition = 'center';
                div.style.backgroundRepeat = 'no-repeat';
                
                if(img.parentNode) {
                    img.parentNode.replaceChild(div, img);
                }
            });
        }

        // --- EXPORT FUNCTIONS ---
        
        async function downloadPDF() {
            const btn = document.getElementById('downloadPdfBtn');
            const overlay = document.getElementById('loadingOverlay');
            
            btn.disabled = true;
            overlay.classList.remove('hidden');
            overlay.classList.add('flex'); 

            try {
                await new Promise(resolve => setTimeout(resolve, 500));

                // 1. Calculate Base Dimensions
                let baseWidth, baseHeight;
                if (state.ratio === 'portrait') { baseWidth = 800; baseHeight = 1066; }
                else if (state.ratio === 'square') { baseWidth = 800; baseHeight = 800; }
                else if (state.ratio === 'landscape') { baseWidth = 1200; baseHeight = 675; }
                else if (state.ratio === 'story') { baseWidth = 600; baseHeight = 1066; }

                const poster = document.getElementById('posterArea'); 

                const canvas = await html2canvas(poster, {
                    scale: 3,  // Quality scale
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: state.bgColor,
                    width: baseWidth, // Force exact width
                    height: baseHeight, // Force exact height
                    windowWidth: baseWidth,
                    windowHeight: baseHeight,
                    onclone: (clonedDoc) => {
                        const clonedEl = clonedDoc.getElementById('posterArea');
                        const clonedWrapper = clonedDoc.getElementById('wrapper');
                        
                        // Force styles on clone to prevent layout shifts
                        if(clonedWrapper) {
                            clonedWrapper.style.transform = 'none';
                            clonedWrapper.style.position = 'static';
                            clonedWrapper.style.width = baseWidth + 'px';
                            clonedWrapper.style.height = baseHeight + 'px';
                        }
                        
                        clonedEl.style.width = baseWidth + 'px';
                        clonedEl.style.height = baseHeight + 'px';
                        clonedEl.style.transform = 'none';
                        clonedEl.style.position = 'relative';
                        clonedEl.style.top = '0';
                        clonedEl.style.left = '0';

                        // Fixes
                        polyfillImages(clonedDoc);
                        const allText = clonedDoc.querySelectorAll('*');
                        allText.forEach(el => {
                            el.style.fontVariantLigatures = 'none';
                            el.style.textRendering = 'geometricPrecision';
                        });
                    }
                });

                const imgData = canvas.toDataURL('image/png');
                const { jsPDF } = window.jspdf;
                
                let orientation = state.ratio === 'landscape' ? 'l' : 'p';
                const pdf = new jsPDF({ orientation: orientation, unit: 'mm', format: 'a4' });

                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                pdf.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
                pdf.save(`Mama_Watoto_${Date.now()}.pdf`);

            } catch (err) {
                console.error("PDF Error:", err);
                alert("Error generating PDF.");
            } finally {
                btn.disabled = false;
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        }

        async function downloadPoster() {
            const btn = document.getElementById('downloadBtn');
            const overlay = document.getElementById('loadingOverlay');
            const poster = document.getElementById('posterArea');
            
            btn.disabled = true;
            overlay.classList.remove('hidden');
            overlay.classList.add('flex'); 

            try {
                await new Promise(resolve => setTimeout(resolve, 500));

                // 1. Calculate Base Dimensions
                let baseWidth, baseHeight;
                if (state.ratio === 'portrait') { baseWidth = 800; baseHeight = 1066; }
                else if (state.ratio === 'square') { baseWidth = 800; baseHeight = 800; }
                else if (state.ratio === 'landscape') { baseWidth = 1200; baseHeight = 675; }
                else if (state.ratio === 'story') { baseWidth = 600; baseHeight = 1066; }

                const canvas = await html2canvas(poster, {
                    scale: 3, 
                    useCORS: true,
                    allowTaint: true,
                    backgroundColor: state.bgColor,
                    logging: false,
                    width: baseWidth, // Force exact width
                    height: baseHeight, // Force exact height
                    windowWidth: baseWidth,
                    windowHeight: baseHeight,
                    onclone: (clonedDoc) => {
                        const clonedEl = clonedDoc.getElementById('posterArea');
                        const clonedWrapper = clonedDoc.getElementById('wrapper');
                        
                        // Force styles on clone to prevent layout shifts
                        if(clonedWrapper) {
                            clonedWrapper.style.transform = 'none';
                            clonedWrapper.style.position = 'static';
                            clonedWrapper.style.width = baseWidth + 'px';
                            clonedWrapper.style.height = baseHeight + 'px';
                        }
                        
                        clonedEl.style.width = baseWidth + 'px';
                        clonedEl.style.height = baseHeight + 'px';
                        clonedEl.style.transform = 'none';
                        clonedEl.style.position = 'relative';
                        clonedEl.style.top = '0';
                        clonedEl.style.left = '0';

                        // 1. Fix Image Stretching/Fitting
                        polyfillImages(clonedDoc);
                        
                        // 2. Fix Text Kerning issues in some browsers
                        const allText = clonedDoc.querySelectorAll('*');
                        allText.forEach(el => {
                             // Ensure high quality text rendering
                             el.style.fontVariantLigatures = 'none';
                             el.style.textRendering = 'geometricPrecision';
                        });
                    }
                });

                const link = document.createElement('a');
                link.download = `Mama_Watoto_${Date.now()}.png`;
                link.href = canvas.toDataURL('image/png', 1.0);
                link.click();

            } catch (err) {
                console.error("Download Error:", err);
                alert("Error generating Image. Please try a different photo or browser.");
            } finally {
                btn.disabled = false;
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        }

    </script>
</body>
</html>
